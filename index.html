<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One push one happiness</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Clubhouse-inspired Color Palette */
        :root {
            --bg-main: #f0ede6; 
            --bg-card: #ffffff; 
            --text-primary: #333333; 
            --text-secondary: #5c5c5c; 
            --accent-primary: #5a8dee; 
            --accent-primary-hover: #4a7bdc;
            --accent-secondary: #e7e7e1; 
            --accent-secondary-hover: #dcd9d1;
            --border-color: #d1cdc7; 
            --highlight-bg: #e8e5dd; 
            --completed-mark: #50c878; 
            --icon-color-default: #7b92a8; 
            
            --cancel-button-bg-light-blue: #8cb4f5; 
            --cancel-button-hover-bg-light-blue: #79a3e8; 
            --cancel-button-disabled-bg-light-blue: #adcaf7; 
            --cancel-button-disabled-text-light-blue: #607db7; 
        }

        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
        }
        .card {
            background-color: var(--bg-card);
            border-radius: 16px; 
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.05), 0 3px 6px rgba(0, 0, 0, 0.04);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.07), 0 6px 12px rgba(0, 0, 0, 0.05);
        }
        .suggestion-card-container {
            cursor: grab;
            user-select: none;
            touch-action: pan-y;
            border: 1px solid var(--border-color);
            background-color: var(--bg-card); 
        }
        .suggestion-card-container.dragging {
            cursor: grabbing;
            box-shadow: 0 15px 30px rgba(0,0,0,0.1), 0 8px 15px rgba(0,0,0,0.08);
            transform: scale(1.02);
        }
        .btn {
            border-radius: 20px; 
            padding: 10px 24px;
            font-weight: 600; 
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.2s;
            border: none; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            white-space: nowrap; /* ボタンテキストの改行を防ぐ */
        }
        .btn:hover {
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
             transform: translateY(-2px);
        }
        .btn-primary {
            background-color: var(--accent-primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: var(--accent-primary-hover);
        }
        .btn-primary:disabled {
            background-color: #a0aec0; 
            cursor: not-allowed;
        }
        .btn-cancel { 
            background-color: var(--cancel-button-bg-light-blue);
            color: white;
        }
        .btn-cancel:hover {
            background-color: var(--cancel-button-hover-bg-light-blue);
        }
        .btn-cancel:disabled {
            background-color: var(--cancel-button-disabled-bg-light-blue); 
            color: var(--cancel-button-disabled-text-light-blue);
            cursor: not-allowed;
        }
        .btn-outline {
            background-color: var(--bg-card);
            border: 1.5px solid var(--accent-primary);
            color: var(--accent-primary);
        }
        .btn-outline:hover {
            background-color: var(--highlight-bg);
            border-color: var(--accent-primary-hover);
            color: var(--accent-primary-hover);
        }
        .btn-outline:disabled {
            border-color: #cbd5e0; 
            color: #a0aec0; 
            background-color: var(--bg-card);
            cursor: not-allowed;
        }
        .calendar-day {
            width: calc(100% / 7 - 4px);
            aspect-ratio: 1 / 1;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: var(--text-secondary);
        }
        .calendar-day:hover {
            background-color: var(--highlight-bg);
        }
        .calendar-day.has-task {
            background-color: #fffadf; 
            color: #8c7000; 
            font-weight: bold;
        }
        .calendar-day.today {
            border: 2px solid var(--accent-primary);
            background-color: var(--highlight-bg);
            color: var(--accent-primary);
        }
        .calendar-day.other-month {
            color: #b0b0a7; 
            background-color: var(--bg-main); 
            cursor: default;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); 
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: var(--bg-card);
            margin: 10% auto;
            padding: 28px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            animation: slideInUp 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close-button {
            color: var(--text-secondary);
            float: right;
            font-size: 28px;
            font-weight: bold;
            transition: color 0.2s;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
        }
        .icon-placeholder {
            font-size: 3.5rem; 
            color: var(--icon-color-default); 
            text-shadow: none; 
        }
        .suggestion-image {
            width: 100%;
            max-width: 280px; /* Increased size */
            height: auto;
            max-height: 200px; /* Increased size */
            object-fit: contain;
            margin-bottom: 1rem;
        }
        .swipe-indicator {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .task-list-item {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        .task-list-item:last-child {
            border-bottom: none;
        }
        .completed-mark {
            color: var(--completed-mark);
            font-weight: bold;
        }
        input[type="checkbox"] {
            accent-color: var(--accent-primary);
            border-radius: 4px;
            border: 1.5px solid var(--border-color);
        }
        input[type="text"] {
            background-color: #f7f7f5; 
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        input[type="text"]:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(90, 141, 238, 0.2); 
        }
        .app-header h1 {
            color: var(--text-primary); 
            font-weight: 700; 
        }
        .app-header p {
            color: var(--text-secondary); 
        }
        .card h2 {
            color: var(--text-primary);
        }
        #addCustomTaskBtn {
            background-color: #6c757d; 
            color: white;
        }
        #addCustomTaskBtn:hover {
            background-color: #5a6268;
        }
        #todayTaskIcon.fas.fa-star { 
             color: #f5c518; 
        }
        #suggestionIcon.fas.fa-check-circle {
            color: var(--completed-mark); 
        }
        #suggestionText {
            max-height: 8rem; 
            overflow-y: auto;
            width: 100%; 
            scrollbar-width: thin; 
            scrollbar-color: var(--border-color) var(--bg-card); 
        }
        #suggestionText::-webkit-scrollbar {
            width: 6px;
        }
        #suggestionText::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 3px;
        }
        #suggestionText::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 3px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 md:p-8">
    <header class="mb-8 text-center app-header">
        <h1 class="text-4xl font-bold">
            <i class="fas fa-rocket mr-2 text-yellow-500"></i>One push one happiness
        </h1>
        <p class="text-lg mt-2">一日いっこ心躍ることをしてみよう！</p> 
    </header>

    <main class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8">
        <section class="space-y-6">
            <div class="card p-6 relative">
                <h2 class="text-2xl font-semibold mb-4">今日のチョイス <i class="fas fa-lightbulb text-yellow-400"></i></h2>
                <div id="suggestionCardContainer" class="suggestion-card-container p-6 rounded-lg min-h-[300px] flex flex-col text-center relative"> 
                    <div id="suggestionContent" class="flex flex-col items-center flex-grow">
                        <!-- Content will be injected here -->
                    </div>
                    <div class="swipe-indicator hidden md:block mt-2"> <i class="fas fa-arrows-left-right mr-1"></i> スワイプ or ボタンで次へ
                    </div>
                </div>
                <!-- Button container updated -->
                <div class="flex justify-center items-center mt-4 space-x-2 md:space-x-4">
                    <button id="prevBtn" class="btn btn-outline p-3"><i class="fas fa-arrow-left mr-2"></i>戻る</button>
                    <button id="acceptBtn" class="btn btn-primary"><i class="fas fa-check mr-2"></i>これにする！</button>
                    <button id="nextBtn" class="btn btn-outline p-3">次へ<i class="fas fa-arrow-right ml-2"></i></button>
                </div>
            </div>

            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-4">今日の心躍ること <i class="fas fa-star text-yellow-400"></i></h2>
                <div id="todayTaskContainer" class="p-4 rounded-lg border min-h-[100px]" style="border-color: var(--border-color); background-color: #f9f9f7;">
                     <div id="todayTaskContent" class="flex flex-col items-center text-center">
                        <!-- Content will be injected here -->
                     </div>
                </div>
                <div class="mt-4 flex items-center space-x-3">
                    <input type="checkbox" id="taskCompletedCheckbox" class="h-5 w-5 rounded focus:ring-offset-0" style="border-color: var(--border-color);" disabled>
                    <label for="taskCompletedCheckbox" class="">完了したらチェック！</label>
                </div>
            </div>

            <div class="card p-6">
                <h2 class="text-2xl font-semibold mb-4">自分で決める <i class="fas fa-pencil-alt text-green-500"></i></h2>
                <div class="flex flex-col space-y-3">
                    <input type="text" id="customTaskInput" placeholder="例：新しい道を散歩する" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-opacity-50" style="border-color: var(--border-color); background-color: #fdfcfb;">
                    <button id="addCustomTaskBtn" class="btn"><i class="fas fa-plus mr-2"></i>これを今日やることにする</button>
                </div>
            </div>
        </section>

        <section class="card p-6">
            <h2 class="text-2xl font-semibold mb-4">カレンダー <i class="fas fa-calendar-alt text-blue-400"></i></h2> 
            <div class="flex justify-between items-center mb-4">
                <button id="prevMonthBtn" class="btn btn-outline !p-2"><i class="fas fa-chevron-left"></i></button>
                <h3 id="calendarMonthYear" class="text-xl font-medium"></h3>
                <button id="nextMonthBtn" class="btn btn-outline !p-2"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                </div>
        </section>
    </main>

    <div id="taskModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <h3 id="modalDate" class="text-xl font-semibold mb-3"></h3>
            <div id="modalTaskList" class="space-y-2">
                </div>
        </div>
    </div>

    <footer class="mt-12 text-center text-sm">
        <p>&copy; <span id="currentYear"></span> One push one happiness. All rights reserved.</p>
    </footer>

    <script>
        // --- Initial Data ---
        const kokoroOdoruSuggestions = [
            { id: "s1", text: "新しいカフェを開拓してみよう", icon: "fas fa-coffee", category: "外出" },
            { id: "s2", text: "ふだん読まないジャンルの本を読んでみよう", icon: "fas fa-book-open", category: "学習" },
            { id: "s3", text: "公園で30分くらい日光浴をしてみよう", icon: "fas fa-sun", category: "健康" },
            { id: "s4", text: "誰かに感謝のメッセージを送ってみよう", icon: "fas fa-paper-plane", category: "人間関係" },
            { id: "s5", text: "5分間瞑想してみよう", icon: "fas fa-brain", category: "リラックス" },
            { id: "s6", text: "新しいレシピに挑戦してみよう", icon: "fas fa-utensils", category: "趣味" },
            { id: "s7", text: "近所を散歩して新しいお店を見つけてみよう", icon: "fas fa-map-marked-alt", category: "運動" },
            { id: "s8", text: "好きな音楽をかけてちょっとおどってみよう", icon: "fas fa-music", category: "エンタメ" },
            { id: "s9", text: "お部屋をすこし模様替えしてみよう", icon: "fas fa-couch", category: "生活" },
            { id: "s10", text: "寝る前に今日あった良いことを3つ書き出してみよう", icon: "fas fa-pencil-alt", category: "自己啓発" },
            { id: "s11", text: "空の写真を撮ってみよう", icon: "fas fa-camera-retro", category: "趣味" },
            { id: "s12", text: "植物に水をあげてちょっと観察してみよう", icon: "fas fa-seedling", category: "癒し" },
            { id: "s13", text: "15分早く起きて静かな時間を過ごしてみよう", icon: "fas fa-clock", category: "習慣" },
            { id: "s14", text: "手書きで短い手紙やメモを書いてみよう", icon: "fas fa-pen-nib", category: "表現" },
            { id: "s15", text: "行ったことのないスーパーマーケットに行ってみよう", icon: "fas fa-shopping-cart", category: "発見" },
            { id: "s16", text: "蝉の抜け殻触ってみよう", icon: "fas fa-bug", category: "自然" },
            { id: "s17", text: "利き手じゃない方でごはんを食べてみよう", icon: "fas fa-utensils", category: "挑戦" },
            { id: "s18", text: "1分間空をみあげてみよう", icon: "fas fa-cloud", category: "リラックス" },
            { id: "s19", text: "いつもより10分早くお家出てみよう", icon: "fas fa-door-open", category: "習慣" },
            { id: "s20", text: "はじめてのお店に入ってみよう", icon: "fas fa-store", category: "発見" },
            { id: "s21", text: "朝ジョギングしてみよう P.S. ウォーキングでもいいよ", icon: "fas fa-running", category: "運動" },
            { id: "s22", text: "朝ごはんにミューズリーたべよう（ミューズリー？）", icon: "fas fa-bowl-rice", category: "食事" },
            { id: "s23", text: "誰かにお手紙を書いてみよう", icon: "fas fa-envelope-open-text", category: "人間関係" },
            { id: "s24", text: "いつもとちがう道通って目的地行こう", icon: "fas fa-route", category: "発見" },
            { id: "s25", text: "ふだん苦手であんまし食べないもの食べてみよう", icon: "fas fa-pepper-hot", category: "挑戦" },
            { id: "s27", text: "急に逆立ちしてみよう", icon: "fas fa-child", category: "挑戦" },
            { id: "s28", text: "朝、スクランブルエッグをつくってみよう", icon: "fas fa-egg", category: "料理" },
            { id: "s29", text: "利き手じゃない方の手で歯磨きしてみよう", icon: "fas fa-tooth", category: "挑戦" },
            { id: "s30", text: "ご飯食べるとき、TVとかスマホを消してみよう", icon: "fas fa-comment-slash", category: "習慣" },
            { id: "s31", text: "ご飯食べるとき、一口30回以上噛んで食べてみよう", icon: "fas fa-grin-tongue", category: "健康" },
            { id: "s32", text: "朝ごはん、いつもパンの人はお米にしてみよう", icon: "fas fa-exchange-alt", category: "食事" },
            { id: "s33", text: "用もないのに誰かに電話かけてみよう", icon: "fas fa-phone-volume", category: "人間関係" },
            { id: "s34", text: "街で見かけた人の人生について想像してみよう", icon: "fas fa-theater-masks", category: "想像力" },
            { id: "s35", text: "くつした履かないでくつ履いてみよう", icon: "fas fa-shoe-prints", category: "感覚" },
            { id: "s36", text: "散歩中の犬をなでさせてもらおう", icon: "fas fa-dog", category: "交流" },
            { id: "s37", text: "ものを買ったあとにありがとうって言ってみよう", icon: "fas fa-handshake", category: "感謝" },
            { id: "s38", text: "トイレをピカピカにしてみよう", icon: "fas fa-toilet", category: "生活" },
            { id: "s39", text: "朝1時間だけはやく起きてみよう", icon: "fas fa-hourglass-start", category: "習慣" },
            { id: "s40", text: "うしろ向きに歩いてみよう", icon: "fas fa-people-arrows", category: "挑戦" },
            { id: "s41", text: "電車乗るとき切符買ってみよう", icon: "fas fa-ticket-alt", category: "体験" },
            { id: "s42", text: "洋服を丁寧にたたんでみよう", icon: "fas fa-tshirt", category: "生活" },
            { id: "s43", text: "ごはん食べるとき、TVとかスマホを消してみよう", icon: "fas fa-plug", category: "習慣" },
            { id: "s44", text: "食後に果物食べてみよう", icon: "fas fa-apple-alt", category: "食事" },
            { id: "s45", text: "140文字で物語をつくってみよう", icon: "fas fa-feather-alt", category: "創造性" },
            { id: "s46", text: "断られても良いから電車で席をゆずってみよう", icon: "fas fa-chair", category: "親切" },
            { id: "s47", text: "自然の多いところに行ってみよう", icon: "fas fa-tree", category: "癒し" },
            { id: "s48", text: "雨ん中傘をささずに歩いてみよう", icon: "fas fa-cloud-showers-heavy", category: "挑戦" },
            { id: "s49", text: "初めて入る映画館で映画を観てみよう", icon: "fas fa-film", category: "エンタメ" },
            { id: "s50", text: "暑いけどちょっとセーターを着てみよう", icon: "fas fa-user-tie", category: "挑戦" },
            { id: "s51", text: "通勤中（通学中）に街路樹の数をかぞえてみよう", icon: "fas fa-hashtag", category: "観察" },
            { id: "s52", text: "朝起きた直後にお気に入りの音楽を流してみよう", icon: "fas fa-play-circle", category: "気分転換" },
            { id: "s53", text: "外に出て、木の葉に触れてみよう", icon: "fas fa-leaf", category: "自然" },
            { id: "s54", text: "3分間きっちり歯を磨いてみよう", icon: "fas fa-stopwatch", category: "健康" },
            { id: "s55", text: "街の中で色々な匂いに意識を向けてみよう", icon: "fas fa-wind", category: "感覚" },
            { id: "s56", text: "ふだん聴かないジャンルの音楽を聴いてみよう", icon: "fas fa-headphones-alt", category: "発見" },
            { id: "s57", text: "お花を一輪、へやにかざってみよう", icon: "fas fa-spa", category: "癒し" },
            { id: "s58", text: "まえの日見た夢をノートに書きとめよう", icon: "fas fa-moon", category: "自己理解" },
            { id: "s59", text: "朝10分瞑想してみよう", icon: "fas fa-peace", category: "リラックス" },
            { id: "s60", text: "湯船に温泉の素入れてみよう", icon: "fas fa-hot-tub", category: "リラックス" },
            { id: "s61", text: "ハリウッド映画みたいにお風呂を泡泡にしてみよう", icon: "fas fa-soap", category: "遊び心" },
            { id: "s62", text: "空の色に名前をつけてみよう", icon: "fas fa-palette", category: "創造性" },
            { id: "s63", text: "ごはんの時にきちんと“いただきます”って言ってみよう", icon: "fas fa-hands-praying", category: "感謝" },
            { id: "s64", text: "ノンカフェインのコーヒー夜に飲んでみよう", icon: "fas fa-mug-hot", category: "体験" },
            { id: "s65", text: "ドングリを3個ひろってみよう", icon: "fas fa-fan", category: "自然" }
        ];

        // --- State Variables ---
        let currentSuggestion = null;
        let suggestionHistory = []; 
        let historyIndex = -1; 
        let todayTask = null; 
        let completedTasks = []; 
        let calendarDate = new Date();

        // --- DOM Elements ---
        const suggestionCardContainer = document.getElementById('suggestionCardContainer'); 
        const suggestionContentEl = document.getElementById('suggestionContent');
        const acceptBtn = document.getElementById('acceptBtn');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn'); // New button
        
        const todayTaskContentEl = document.getElementById('todayTaskContent');
        const taskCompletedCheckbox = document.getElementById('taskCompletedCheckbox');

        const customTaskInput = document.getElementById('customTaskInput');
        const addCustomTaskBtn = document.getElementById('addCustomTaskBtn');

        const calendarGrid = document.getElementById('calendarGrid');
        const calendarMonthYearEl = document.getElementById('calendarMonthYear');
        const prevMonthBtnCalendar = document.getElementById('prevMonthBtn');
        const nextMonthBtnCalendar = document.getElementById('nextMonthBtn');

        const taskModal = document.getElementById('taskModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalDateEl = document.getElementById('modalDate');
        const modalTaskListEl = document.getElementById('modalTaskList');
        
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // --- Functions ---
        
        function isImageSuggestion(suggestionId) {
            if (!suggestionId) return false;
            const idNumber = parseInt(suggestionId.substring(1), 10);
            // Updated range to include s27-s31
            return (idNumber >= 16 && idNumber <= 25) || (idNumber >= 27 && idNumber <= 31);
        }

        function loadData() {
            const storedTodayTask = localStorage.getItem('kokoroOdoruTodayTask');
            const storedCompletedTasks = localStorage.getItem('kokoroOdoruCompletedTasks');
            let storedHistory = localStorage.getItem('kokoroOdoruSuggestionHistory');
            let storedHistoryIndex = localStorage.getItem('kokoroOdoruHistoryIndex');
            let storedHistoryDate = localStorage.getItem('kokoroOdoruHistoryDate');
            const todayString = getTodayString();

            if (storedTodayTask) {
                const parsedTask = JSON.parse(storedTodayTask);
                if (parsedTask.dateAdded === todayString) {
                    todayTask = parsedTask;
                } else { 
                    localStorage.removeItem('kokoroOdoruTodayTask');
                    // Clear all history if task is old, as history is tied to the suggestion flow of a day
                    localStorage.removeItem('kokoroOdoruSuggestionHistory');
                    localStorage.removeItem('kokoroOdoruHistoryIndex');
                    localStorage.removeItem('kokoroOdoruHistoryDate');
                    suggestionHistory = [];
                    historyIndex = -1;
                    storedHistory = null; // Nullify to prevent loading old history below
                    storedHistoryIndex = null;
                    storedHistoryDate = null;
                }
            }
            
            if (!todayTask) { // Only load/process history if no task is active for today
                if (storedHistoryDate === todayString && storedHistory) {
                    try {
                        suggestionHistory = JSON.parse(storedHistory);
                        if (!Array.isArray(suggestionHistory)) suggestionHistory = []; // Ensure it's an array
                    } catch (e) {
                        console.error("Error parsing stored history:", e);
                        suggestionHistory = [];
                    }

                    if (storedHistoryIndex !== null) {
                        historyIndex = parseInt(storedHistoryIndex, 10);
                        if (isNaN(historyIndex) || historyIndex < 0 || historyIndex >= suggestionHistory.length) {
                            historyIndex = suggestionHistory.length > 0 ? suggestionHistory.length - 1 : -1;
                        }
                    } else {
                         historyIndex = suggestionHistory.length > 0 ? suggestionHistory.length - 1 : -1;
                    }
                } else { 
                    localStorage.removeItem('kokoroOdoruSuggestionHistory');
                    localStorage.removeItem('kokoroOdoruHistoryIndex');
                    localStorage.removeItem('kokoroOdoruHistoryDate');
                    suggestionHistory = [];
                    historyIndex = -1;
                }
            }

            if (storedCompletedTasks) {
                try {
                    completedTasks = JSON.parse(storedCompletedTasks);
                    if (!Array.isArray(completedTasks)) completedTasks = [];
                } catch (e) {
                    console.error("Error parsing completed tasks:", e);
                    completedTasks = [];
                }
            }
        }

        function saveData() {
            if (todayTask) {
                localStorage.setItem('kokoroOdoruTodayTask', JSON.stringify(todayTask));
            } else {
                localStorage.removeItem('kokoroOdoruTodayTask');
            }
            localStorage.setItem('kokoroOdoruCompletedTasks', JSON.stringify(completedTasks));
            
            localStorage.setItem('kokoroOdoruSuggestionHistory', JSON.stringify(suggestionHistory));
            localStorage.setItem('kokoroOdoruHistoryIndex', historyIndex.toString());
            localStorage.setItem('kokoroOdoruHistoryDate', getTodayString());
        }

        function getTodayString() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        function displaySuggestion(suggestionToDisplay) {
            currentSuggestion = suggestionToDisplay;
            suggestionContentEl.innerHTML = ''; // Clear previous content

            if (suggestionToDisplay) {
                if (isImageSuggestion(suggestionToDisplay.id)) {
                    const img = document.createElement('img');
                    img.src = `${suggestionToDisplay.id}.png`;
                    img.alt = suggestionToDisplay.text;
                    img.className = 'suggestion-image';
                    suggestionContentEl.appendChild(img);
                } else {
                    const icon = document.createElement('div');
                    icon.className = `icon-placeholder ${suggestionToDisplay.icon}`;
                    suggestionContentEl.appendChild(icon);
                }
                const text = document.createElement('p');
                text.id = 'suggestionText';
                text.className = 'text-lg';
                text.textContent = suggestionToDisplay.text;
                suggestionContentEl.appendChild(text);
            } else {
                const text = document.createElement('p');
                text.textContent = "提案がありません。";
                suggestionContentEl.appendChild(text);
                const icon = document.createElement('div');
                icon.className = "icon-placeholder fas fa-meh";
                suggestionContentEl.insertBefore(icon, text);
            }
            suggestionCardContainer.style.transform = '';
        }
        
        function generateAndShowNewSuggestion() {
            if (kokoroOdoruSuggestions.length === 0) {
                displaySuggestion(null); 
                return;
            }

            let newSuggestion;
            let attempts = 0;
            const maxAttempts = kokoroOdoruSuggestions.length * 2 + 5; 

            const avoidSuggestionId = currentSuggestion ? currentSuggestion.id : null;

            if (kokoroOdoruSuggestions.length <= 1) { 
                newSuggestion = kokoroOdoruSuggestions.length > 0 ? kokoroOdoruSuggestions[0] : null;
            } else {
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * kokoroOdoruSuggestions.length);
                    newSuggestion = kokoroOdoruSuggestions[randomIndex];
                    attempts++;
                } while (
                    newSuggestion.id === avoidSuggestionId && 
                    attempts < maxAttempts
                );

                if (newSuggestion.id === avoidSuggestionId && attempts >= maxAttempts) {
                    console.warn("Could not find a different suggestion from the current one after max attempts. Picking next sequentially.");
                    let currentIdxInMasterList = kokoroOdoruSuggestions.findIndex(s => s.id === avoidSuggestionId);
                    if (currentIdxInMasterList !== -1) { 
                        newSuggestion = kokoroOdoruSuggestions[(currentIdxInMasterList + 1) % kokoroOdoruSuggestions.length];
                    } else { 
                        newSuggestion = kokoroOdoruSuggestions.find(s => s.id !== avoidSuggestionId) || kokoroOdoruSuggestions[0];
                    }
                }
            }

            if (historyIndex < suggestionHistory.length - 1) {
                suggestionHistory = suggestionHistory.slice(0, historyIndex + 1);
            }
            
            suggestionHistory.push(newSuggestion);
            historyIndex = suggestionHistory.length - 1;
            displaySuggestion(newSuggestion); 
            saveData(); 
        }

        function showNextSuggestion() {
            if (historyIndex < suggestionHistory.length - 1) {
                historyIndex++;
                displaySuggestion(suggestionHistory[historyIndex]);
            } else {
                generateAndShowNewSuggestion(); 
            }
            saveData(); 
        }

        function showPreviousSuggestion() {
            if (historyIndex > 0) {
                historyIndex--;
                displaySuggestion(suggestionHistory[historyIndex]);
                saveData(); 
            } else {
                console.log("これ以上前の提案はありません。");
                suggestionCardContainer.style.transition = 'transform 0.1s ease-in-out';
                suggestionCardContainer.style.transform = 'translateX(10px)';
                setTimeout(() => { suggestionCardContainer.style.transform = 'translateX(-10px)'; }, 100);
                setTimeout(() => { suggestionCardContainer.style.transform = 'translateX(0px)'; }, 200);
            }
        }

        function updateTodayTaskDisplay() {
            todayTaskContentEl.innerHTML = ''; // Clear content

            if (todayTask) {
                if (isImageSuggestion(todayTask.id)) {
                    const img = document.createElement('img');
                    img.src = `${todayTask.id}.png`;
                    img.alt = todayTask.text;
                    img.className = 'suggestion-image mx-auto'; // Center the image
                    todayTaskContentEl.appendChild(img);
                } else if (todayTask.icon) {
                    const icon = document.createElement('div');
                    icon.className = `icon-placeholder ${todayTask.icon}`;
                    if (todayTask.icon === 'fas fa-star') {
                        icon.style.color = 'var(--accent-primary)'; 
                    }
                    todayTaskContentEl.appendChild(icon);
                } else {
                    const icon = document.createElement('div');
                    icon.className = 'icon-placeholder fas fa-star'; 
                    icon.style.color = 'var(--accent-primary)';
                    todayTaskContentEl.appendChild(icon);
                }

                const text = document.createElement('p');
                text.className = 'text-lg mt-2';
                text.textContent = todayTask.text;
                todayTaskContentEl.appendChild(text);
                
                taskCompletedCheckbox.disabled = false;
                taskCompletedCheckbox.checked = todayTask.completed;

                acceptBtn.innerHTML = '<i class="fas fa-times mr-2"></i>やっぱりやめる';
                acceptBtn.classList.remove('btn-primary');
                acceptBtn.classList.add('btn-cancel'); 
                acceptBtn.disabled = todayTask.completed; 

                nextBtn.disabled = true;
                prevBtn.disabled = true; // Disable prev button
                customTaskInput.disabled = true;
                addCustomTaskBtn.disabled = true;
                
                suggestionContentEl.innerHTML = `
                    <div class="icon-placeholder fas fa-check-circle" style="color: var(--completed-mark);"></div>
                    <p id="suggestionText" class="text-lg">今日の心躍ることは設定済みです！</p>`;

            } else { 
                const text = document.createElement('p');
                text.className = 'text-lg';
                text.textContent = "まだ設定されていません。";
                todayTaskContentEl.appendChild(text);
                
                taskCompletedCheckbox.disabled = true;
                taskCompletedCheckbox.checked = false;

                acceptBtn.innerHTML = '<i class="fas fa-check mr-2"></i>これにする！';
                acceptBtn.classList.remove('btn-cancel');
                acceptBtn.classList.add('btn-primary');
                acceptBtn.disabled = !currentSuggestion; 

                nextBtn.disabled = false;
                prevBtn.disabled = false; // Enable prev button
                customTaskInput.disabled = false;
                addCustomTaskBtn.disabled = false;
                
                if (currentSuggestion) { 
                    displaySuggestion(currentSuggestion);
                } else if (suggestionHistory.length > 0 && historyIndex >=0 && historyIndex < suggestionHistory.length) {
                    displaySuggestion(suggestionHistory[historyIndex]);
                } else if (kokoroOdoruSuggestions.length > 0) { 
                    generateAndShowNewSuggestion();
                } else {
                     displaySuggestion(null); 
                }
            }
            saveData(); 
            renderCalendar();
        }
        
        function setTodayTask(id, text, icon = null) {
            todayTask = {
                id: id,
                text: text,
                icon: icon || 'fas fa-star', 
                completed: false,
                dateAdded: getTodayString()
            };
            updateTodayTaskDisplay();
        }

        acceptBtn.addEventListener('click', () => {
            if (todayTask && todayTask.dateAdded === getTodayString()) { 
                if (todayTask.completed) {
                    console.warn("完了済みのタスクはキャンセルできません。まず未完了にしてください。");
                    return; 
                }
                todayTask = null; 
                if (suggestionHistory.length > 0 && historyIndex >= 0 && historyIndex < suggestionHistory.length) {
                    displaySuggestion(suggestionHistory[historyIndex]);
                } else if (kokoroOdoruSuggestions.length > 0) {
                    generateAndShowNewSuggestion();
                } else {
                    displaySuggestion(null);
                }
                updateTodayTaskDisplay(); 
            } else if (currentSuggestion && !acceptBtn.disabled) { 
                setTodayTask(currentSuggestion.id, currentSuggestion.text, currentSuggestion.icon);
            }
        });

        nextBtn.addEventListener('click', () => {
            if (!nextBtn.disabled) { 
                 showNextSuggestion();
            }
        });
        
        prevBtn.addEventListener('click', () => {
            if (!prevBtn.disabled) {
                showPreviousSuggestion();
            }
        });

        addCustomTaskBtn.addEventListener('click', () => {
            if (addCustomTaskBtn.disabled) return;
            const customText = customTaskInput.value.trim();
            if (customText) {
                setTodayTask(null, customText); // Custom tasks have no ID
                customTaskInput.value = '';
            } else {
                console.warn("タスク内容を入力してください。");
            }
        });

        taskCompletedCheckbox.addEventListener('change', () => {
            if (todayTask) {
                todayTask.completed = taskCompletedCheckbox.checked;
                const todayString = getTodayString();
                if (todayTask.completed) {
                    const existingEntryIndex = completedTasks.findIndex(
                        entry => entry.date === todayString && entry.taskText === todayTask.text
                    );
                    if (existingEntryIndex === -1) {
                        completedTasks.push({
                            id: todayTask.id, // Save id for image lookup later
                            date: todayString,
                            taskText: todayTask.text,
                            icon: todayTask.icon
                        });
                    }
                } else {
                    completedTasks = completedTasks.filter(
                        entry => !(entry.date === todayString && entry.taskText === todayTask.text)
                    );
                }
                updateTodayTaskDisplay(); 
            }
        });

        function renderCalendar() {
            calendarGrid.innerHTML = ''; 
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth(); 

            calendarMonthYearEl.textContent = `${year}年 ${month + 1}月`;

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            let dayOfWeekOfFirst = firstDayOfMonth.getDay(); 
            dayOfWeekOfFirst = (dayOfWeekOfFirst === 0) ? 6 : dayOfWeekOfFirst - 1; 
            
            const today = new Date();
            const todayDateString = getTodayString();

            const dayNames = ['月', '火', '水', '木', '金', '土', '日']; 
            dayNames.forEach(name => {
                const dayNameCell = document.createElement('div');
                dayNameCell.className = 'text-center font-medium text-sm py-1';
                dayNameCell.style.color = 'var(--text-secondary)';
                dayNameCell.textContent = name;
                calendarGrid.appendChild(dayNameCell);
            });

            for (let i = 0; i < dayOfWeekOfFirst; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day other-month';
                calendarGrid.appendChild(emptyCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.textContent = day;
                dayCell.className = 'calendar-day';
                
                const currentDateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                if (currentDateString === todayDateString) {
                    dayCell.classList.add('today');
                }

                const tasksOnThisDay = completedTasks.filter(task => task.date === currentDateString);
                if (tasksOnThisDay.length > 0) {
                    dayCell.classList.add('has-task');
                    dayCell.innerHTML = `${day}<span class="completed-mark text-lg ml-1">◎</span>`;
                    dayCell.addEventListener('click', () => showTasksForDay(currentDateString, tasksOnThisDay));
                } else {
                     dayCell.addEventListener('click', () => showTasksForDay(currentDateString, []));
                }
                calendarGrid.appendChild(dayCell);
            }
            const totalCells = dayOfWeekOfFirst + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
             for (let i = 0; i < remainingCells; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day other-month';
                calendarGrid.appendChild(emptyCell);
            }
        }

        prevMonthBtnCalendar.addEventListener('click', () => {
            calendarDate.setMonth(calendarDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtnCalendar.addEventListener('click', () => {
            calendarDate.setMonth(calendarDate.getMonth() + 1);
            renderCalendar();
        });

        function showTasksForDay(dateString, tasks) {
            const [year, month, day] = dateString.split('-');
            modalDateEl.textContent = `${year}年${parseInt(month)}月${parseInt(day)}日の心躍ったこと`;
            modalDateEl.style.color = 'var(--text-primary)';
            modalTaskListEl.innerHTML = ''; 

            if (tasks.length > 0) {
                tasks.forEach(task => {
                    const listItem = document.createElement('div');
                    listItem.className = 'task-list-item flex items-center';
                    
                    let visualHtml = '';
                    if (isImageSuggestion(task.id)) {
                         visualHtml = `<img src="${task.id}.png" alt="${task.taskText}" class="w-8 h-8 object-contain mr-3">`;
                    } else if (task.icon) {
                        let iconColor = task.icon === 'fas fa-star' ? 'var(--accent-primary)' : 'var(--icon-color-default)';
                        visualHtml = `<i class="${task.icon} mr-3 text-xl" style="color: ${iconColor};"></i>`;
                    } else { 
                        visualHtml = `<i class="fas fa-star mr-3 text-xl" style="color: var(--accent-primary);"></i>`;
                    }
                    
                    listItem.innerHTML = `${visualHtml} <span class="">${task.taskText}</span>`;
                    modalTaskListEl.appendChild(listItem);
                });
            } else {
                modalTaskListEl.innerHTML = `<p style="color: var(--text-secondary);">この日に完了した「心躍ること」はありません。</p>`;
            }
            taskModal.style.display = 'flex';
        }

        closeModalBtn.addEventListener('click', () => {
            taskModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target === taskModal) {
                taskModal.style.display = 'none';
            }
        });

        // --- Swipe Functionality for Suggestion Card ---
        let touchstartX = 0;
        let touchendX = 0;
        let isDragging = false; 
        const swipeThreshold = 50; 

        function commonSwipeStart(screenX) {
            if (acceptBtn.classList.contains('btn-cancel') && acceptBtn.disabled === false) { 
                 return false;
            }
            if (todayTask && todayTask.dateAdded === getTodayString()) return false; 

            touchstartX = screenX;
            suggestionCardContainer.classList.add('dragging'); 
            return true;
        }

        function commonSwipeEnd(screenX) {
            if (!suggestionCardContainer.classList.contains('dragging')) return; 

            touchendX = screenX;
            handleSwipeGesture(); 
            suggestionCardContainer.classList.remove('dragging'); 
        }
        
        suggestionCardContainer.addEventListener('touchstart', function(event) { 
            if(commonSwipeStart(event.changedTouches[0].screenX)) {
            }
        }, { passive: false }); 

        suggestionCardContainer.addEventListener('touchmove', function(event) { 
        }, { passive: false });


        suggestionCardContainer.addEventListener('touchend', function(event) { 
            commonSwipeEnd(event.changedTouches[0].screenX);
        }, { passive: true });

        suggestionCardContainer.addEventListener('mousedown', function(event) { 
            if (event.button !== 0) return; 
            if(commonSwipeStart(event.screenX)) {
                isDragging = true; 
            }
        });

        suggestionCardContainer.addEventListener('mousemove', function(event) { 
            if (!isDragging) return;
        });

        suggestionCardContainer.addEventListener('mouseup', function(event) { 
            if (!isDragging) return;
            isDragging = false;
            commonSwipeEnd(event.screenX);
        });
        suggestionCardContainer.addEventListener('mouseleave', function(event) {  
            if (!isDragging) return;
            isDragging = false;
            suggestionCardContainer.classList.remove('dragging'); 
            suggestionCardContainer.style.transform = ''; 
            touchstartX = 0; 
        });


        function handleSwipeGesture() {
            const deltaX = touchendX - touchstartX;
            if (Math.abs(deltaX) < swipeThreshold) {
                suggestionCardContainer.style.transform = ''; 
                return;
            }
            if (todayTask && todayTask.dateAdded === getTodayString()) {
                suggestionCardContainer.style.transform = '';
                return;
            }
            
            const direction = deltaX < 0 ? 1 : -1; // Adjusted for natural swipe (swipe left -> next)

            suggestionCardContainer.style.transition = 'transform 0.3s ease-out';
            suggestionCardContainer.style.transform = `translateX(${direction * -100}%) rotate(${direction * -5}deg)`;
            
            setTimeout(() => {
                if (direction === 1) { // Left swipe
                    showNextSuggestion(); 
                } else { // Right swipe
                    showPreviousSuggestion();
                }
                // Animate in from opposite side
                suggestionCardContainer.style.transition = 'none'; 
                suggestionCardContainer.style.transform = `translateX(${direction * 100}%) rotate(${direction * 5}deg)`;
                
                suggestionCardContainer.offsetHeight; // Force reflow to apply the transform before transition

                suggestionCardContainer.style.transition = 'transform 0.3s ease-out';
                suggestionCardContainer.style.transform = 'translateX(0) rotate(0)';
            }, 300);
            
            touchstartX = 0;
            touchendX = 0;
        }

        // --- Initialization ---
        loadData(); // Load data first
        
        // Initial display logic
        if (todayTask) { 
            updateTodayTaskDisplay(); 
        } else {
            // If no task, try to display from history, or generate new if history is empty/invalid
            if (suggestionHistory.length > 0 && historyIndex >= 0 && historyIndex < suggestionHistory.length) {
                displaySuggestion(suggestionHistory[historyIndex]);
            } else if (kokoroOdoruSuggestions.length > 0) {
                generateAndShowNewSuggestion(); // This will set currentSuggestion via displaySuggestion
            } else {
                displaySuggestion(null); // No suggestions available
            }
            updateTodayTaskDisplay(); // Update UI based on whether a suggestion is now current
        }
        renderCalendar();
    </script>
</body>
</html>
